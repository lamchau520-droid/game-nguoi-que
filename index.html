<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel World RPG</title>
<style>
body{margin:0;background:#000;overflow:hidden}
canvas{display:block;margin:auto;background:#8fd3ff}
#ui{
 position:fixed;top:10px;left:10px;
 color:white;background:rgba(0,0,0,.6);
 padding:8px;border-radius:8px;font-size:14px
}
.controls{
 position:fixed;bottom:15px;width:100%;
 display:flex;justify-content:center;gap:15px
}
.btn{
 width:60px;height:60px;
 border-radius:12px;border:none;
 font-size:22px
}
</style>
</head>

<body>

<div id="ui">
LV: 1<br>
HP: <span id="hp">100</span><br>
Dungeon: <span id="dun">1</span>
</div>

<canvas id="game" width="360" height="640"></canvas>

<div class="controls">
<button class="btn" onclick="moveLeft()">←</button>
<button class="btn" onclick="jump()">↑</button>
<button class="btn" onclick="attack()">⚔</button>
<button class="btn" onclick="moveRight()">→</button>
</div>

<script>
const c=document.getElementById("game");
const x=c.getContext("2d");

// ===== PLAYER =====
const p={
 x:160,y:420,w:32,h:32,
 vy:0,onGround:true,
 dir:1,speed:3,
 hp:100,frame:0,tick:0,moving:false
};

// ===== PET =====
const pet={x:140,y:440};

// ===== ENEMIES =====
let dungeon=1;
let enemies=[];
function spawnEnemies(){
 enemies=[];
 let count=dungeon<3?3:1;
 for(let i=0;i<count;i++){
  enemies.push({
   x:60+Math.random()*240,
   y:420,w:28,h:28,
   hp:dungeon<3?40:200,
   boss:dungeon>=3
  });
 }
}
spawnEnemies();

// ===== IMAGES =====
const idle=new Image(); idle.src="player_idle.png";
const run1=new Image(); run1.src="player_run1.png";
const run2=new Image(); run2.src="player_run2.png";

// ===== DRAW =====
function drawPlayer(){
 let img=idle;
 if(p.moving) img=p.frame?run2:run1;
 x.save();
 x.translate(p.x+p.w/2,p.y);
 x.scale(p.dir,1);
 x.drawImage(img,-p.w/2,0,p.w,p.h);
 x.restore();
}

function drawPet(){
 pet.x+=(p.x-pet.x-30)*0.05;
 x.fillStyle="lime";
 x.fillRect(pet.x,pet.y,16,16);
}

function drawEnemies(){
 enemies.forEach(e=>{
  x.fillStyle=e.boss?"purple":"red";
  x.fillRect(e.x,e.y,e.w,e.h);

  // HP BAR
  x.fillStyle="black";
  x.fillRect(e.x,e.y-6,e.w,4);
  x.fillStyle="lime";
  x.fillRect(e.x,e.y-6,e.w*(e.hp/(e.boss?200:40)),4);
 });
}

// ===== CONTROLS =====
function moveLeft(){p.x-=p.speed;p.dir=-1;p.moving=true}
function moveRight(){p.x+=p.speed;p.dir=1;p.moving=true}
function jump(){
 if(p.onGround){
  p.vy=-12;
  p.onGround=false;
 }
}

// ===== ATTACK =====
function attack(){
 enemies.forEach(e=>{
  if(Math.abs(p.x-e.x)<40){
   e.hp-=20;
  }
 });
}

// ===== GAME LOOP =====
function loop(){
 x.clearRect(0,0,360,640);

 // SKY & GROUND
 x.fillStyle="#8fd3ff";x.fillRect(0,0,360,640);
 x.fillStyle="#1f7a1f";x.fillRect(0,480,360,160);

 // GRAVITY
 p.vy+=0.6;
 p.y+=p.vy;
 if(p.y>=420){p.y=420;p.vy=0;p.onGround=true}

 // ENEMY AI
 enemies.forEach(e=>{
  if(e.hp<=0) return;
  e.x+=Math.sign(p.x-e.x)*0.5;

  // Enemy attack
  if(Math.abs(p.x-e.x)<25){
   p.hp-=0.2;
   document.getElementById("hp").innerText=Math.floor(p.hp);
  }
 });

 // PET ATTACK
 enemies.forEach(e=>{
  if(Math.abs(pet.x-e.x)<25) e.hp-=0.1;
 });

 // REMOVE DEAD
 enemies=enemies.filter(e=>e.hp>0);

 // NEXT DUNGEON
 if(enemies.length===0){
  dungeon++;
  document.getElementById("dun").innerText=dungeon;
  spawnEnemies();
 }

 // ANIMATION
 p.tick++;
 if(p.tick>12){p.frame^=1;p.tick=0}

 drawEnemies();
 drawPet();
 drawPlayer();

 p.moving=false;
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

