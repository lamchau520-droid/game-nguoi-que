<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pixel RPG ‚Äì Dungeon Chest</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
canvas{display:block;margin:auto;image-rendering:pixelated}
#ui{position:fixed;bottom:5px;left:50%;transform:translateX(-50%)}
button{padding:10px;border-radius:8px;border:0;margin:2px}
#hud{position:fixed;top:5px;left:5px;background:#111;padding:6px;border-radius:8px;font-size:12px}
</style>
</head>
<body>

<canvas id="c" width="384" height="640"></canvas>
<div id="hud"></div>

<div id="ui">
<button onclick="move(-1)">‚¨Ö</button>
<button onclick="atk()">‚öî</button>
<button onclick="skill()">üî•</button>
<button onclick="move(1)">‚û°</button>
</div>

<script>
const c=document.getElementById("c"),x=c.getContext("2d");
const T=32;
let cd=0;

// ===== PLAYER =====
let player={x:160,y:360,atk:12,lv:1};
let pet={lv:1};
let inv={};

// ===== DUNGEON =====
let dungeons=[{name:"Hang ƒê√°",lv:1},{name:"R·ª´ng B√≥ng T·ªëi",lv:3}];
let currentDungeon=-1;
let floor=1;

// ===== ENEMY / BOSS =====
let enemies=[];
let boss=null;

// ===== CHEST =====
let chest=null;

// ===== MAP =====
function map(){
 for(let y=0;y<20;y++)
 for(let x2=0;x2<12;x2++){
  x.fillStyle=y<9?"#7dd3fc":y==9?"#22c55e":"#14532d";
  x.fillRect(x2*T,y*T,T,T);
 }
 if(currentDungeon<0){
  x.fillStyle="#7c3aed";
  x.fillRect(176,320,32,32);
 }
}

// ===== DRAW =====
function drawPlayer(){
 x.fillStyle="#000";
 x.fillRect(player.x,player.y,24,24);
}
function drawPet(){
 x.fillStyle=pet.lv>=3?"#facc15":"#a855f7";
 x.fillRect(player.x-18,player.y+8,14,14);
}
function drawEnemies(){
 enemies.forEach(e=>{
  if(e.hp<=0)return;
  x.fillStyle="#991b1b";
  x.fillRect(e.x,e.y,20,20);
  x.fillStyle="red";
  x.fillRect(e.x,e.y-4,20*(e.hp/e.max),3);
 });
}
function drawBoss(){
 if(!boss||boss.hp<=0)return;
 x.fillStyle="#7f1d1d";
 x.fillRect(boss.x,boss.y,40,40);
 x.fillStyle="red";
 x.fillRect(boss.x,boss.y-6,40*(boss.hp/boss.max),4);
}
function drawChest(){
 if(!chest)return;
 x.fillStyle="#facc15";
 x.fillRect(chest.x,chest.y,24,24);
}

// ===== CONTROL =====
function move(d){
 player.x+=d*16;
 player.x=Math.max(0,Math.min(c.width-24,player.x));
 if(currentDungeon<0 && player.x>160 && player.x<200)openMenu();
 checkChest();
}

function atk(){
 enemies.forEach(e=>{
  if(e.hp>0 && Math.abs(player.x-e.x)<50){
   e.hp-=player.atk+pet.lv*2;
  }
 });
 if(boss && boss.hp>0 && Math.abs(player.x-boss.x)<70){
  boss.hp-=player.atk+pet.lv*3;
  if(boss.hp<=0)spawnChest(true);
 }
}

function skill(){
 if(cd>0)return;
 cd=120;
 enemies.forEach(e=>e.hp-=25+pet.lv*2);
 if(boss)boss.hp-=40+pet.lv*3;
}

// ===== DUNGEON =====
function openMenu(){
 let html="<b>Ch·ªçn Dungeon</b><br>";
 dungeons.forEach((d,i)=>{
  html+=player.lv>=d.lv
   ? `<button onclick="enter(${i})">${d.name}</button><br>`
   : `<div style="opacity:.4">${d.name} (Lv ${d.lv})</div>`;
 });
 hudBox(html,true);
}
function enter(i){
 currentDungeon=i;floor=1;spawnFloor();hudBox("",false);
}
function spawnFloor(){
 enemies=[];boss=null;chest=null;
 if(floor<3){
  for(let i=0;i<3;i++)
   enemies.push({x:80+i*80,y:200,hp:40+floor*10,max:40+floor*10});
 }else{
  boss={x:160,y:120,hp:200+floor*60,max:200+floor*60};
 }
}
function nextFloor(){
 floor++;
 if(floor>3){exitDungeon();return;}
 spawnFloor();
}
function exitDungeon(){
 player.lv++;pet.lv++;
 currentDungeon=-1;player.x=160;
 enemies=[];boss=null;chest=null;
}

// ===== CHEST =====
function spawnChest(isBoss){
 chest={x:160,y:200,boss:isBoss};
}
function checkChest(){
 if(chest && Math.abs(player.x-chest.x)<40){
  if(chest.boss){
   inv["V√†ng"]=(inv["V√†ng"]||0)+50;
   inv["Ki·∫øm"]=(inv["Ki·∫øm"]||0)+1;
   pet.lv++;
   exitDungeon();
  }else{
   inv["V√†ng"]=(inv["V√†ng"]||0)+15;
   if(Math.random()<0.3)inv["Ki·∫øm"]=(inv["Ki·∫øm"]||0)+1;
   chest=null;
   nextFloor();
  }
 }
}

// ===== CLEAR CHECK =====
function checkClear(){
 if(currentDungeon>=0 && enemies.length){
  if(enemies.every(e=>e.hp<=0)){
   spawnChest(false);
   enemies=[];
  }
 }
}

// ===== HUD =====
function hud(){
 let t=`LV:${player.lv}<br>Pet:${pet.lv}<br>`;
 t+=currentDungeon>=0?`Dungeon T·∫ßng ${floor}<br>`:"L√†ng<br>";
 t+="Bag: ";
 for(let i in inv)t+=i+"("+inv[i]+") ";
 document.getElementById("hud").innerHTML=t;
}
function hudBox(txt,show){
 let h=document.getElementById("hud");
 if(show)h.innerHTML=txt;
}

// ===== LOOP =====
function loop(){
 x.clearRect(0,0,c.width,c.height);
 map();
 drawEnemies();
 drawBoss();
 drawChest();
 drawPlayer();
 drawPet();
 hud();
 checkClear();
 if(cd>0)cd--;
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
